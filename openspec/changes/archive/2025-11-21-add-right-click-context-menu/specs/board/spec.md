## ADDED Requirements

### Requirement: 画布右键上下文菜单

系统 SHALL 在用户右键点击画布空白区域时显示上下文菜单，提供快速操作选项。

#### Scenario: 右键点击空白区域显示菜单

- **WHEN** 用户在画布空白区域右键点击
- **THEN** 系统必须在点击位置显示上下文菜单
- **AND** 菜单必须包含"Add Topic"选项
- **AND** 菜单位置必须相对鼠标位置适当偏移避免遮挡
- **AND** 菜单必须在用户点击其他区域时自动隐藏

#### Scenario: 右键点击节点显示菜单

- **WHEN** 用户右键点击画布上的节点
- **THEN** 系统必须在点击位置显示上下文菜单
- **AND** 菜单必须包含"Add Topic"选项用于创建新主题
- **AND** 菜单可以包含其他节点相关操作（如编辑、删除等）

#### Scenario: 从右键菜单创建主题

- **WHEN** 用户点击上下文菜单中的"Add Topic"选项
- **THEN** 系统必须打开右侧边栏显示创建表单
- **AND** 必须传递右键点击时的 x, y 坐标位置
- **AND** 侧边栏表单必须预先填充位置信息
- **AND** 上下文菜单必须立即关闭

#### Scenario: 上下文菜单样式和交互

- **WHEN** 上下文菜单显示时
- **THEN** 菜单必须有清晰的视觉样式和边框阴影
- **AND** 菜单项必须有悬停效果和明确的图标
- **AND** 菜单必须支持键盘导航（上下箭头和回车）
- **AND** 菜单必须响应 ESC 键关闭

#### Scenario: 上下文菜单位置管理

- **WHEN** 显示上下文菜单时
- **THEN** 系统必须检测菜单是否会超出视口边界
- **AND** 如果超出边界，菜单必须自动调整位置
- **AND** 菜单必须始终完全可见在视口内
- **AND** 菜单不能被其他 UI 元素遮挡

### Requirement: 坐标位置捕获和传递

系统 MUST 能够准确捕获用户交互时的坐标位置，并将其传递给相关组件和 API。

#### Scenario: 捕获右键点击坐标

- **WHEN** 用户在画布上右键点击
- **THEN** 系统必须捕获相对于画布容器的 x, y 坐标
- **AND** 坐标必须考虑当前的缩放和平移状态
- **AND** 坐标必须是相对于画布逻辑坐标系的准确值
- **AND** 坐标精度必须保持在像素级别

#### Scenario: 坐标位置传递到侧边栏

- **WHEN** 从右键菜单打开创建侧边栏时
- **THEN** 系统必须将捕获的 x, y 坐标传递给侧边栏组件
- **AND** 侧边栏必须接收并存储这些坐标信息
- **AND** 坐标信息必须包含在表单提交数据中
- **AND** 坐标显示可以帮助用户了解主题将被创建的位置

#### Scenario: 坐标位置可视化预览

- **WHEN** 侧边栏显示坐标位置时
- **THEN** 系统可以在画布上显示临时位置指示器
- **AND** 指示器必须显示主题将要创建的确切位置
- **AND** 指示器必须有明显的视觉样式区分
- **AND** 指示器必须在表单提交或取消时清除

#### Scenario: 坐标系转换和处理

- **WHEN** 处理不同来源的坐标时
- **THEN** 系统必须正确转换屏幕坐标到画布坐标
- **AND** 必须考虑 ReactFlow 的视口变换矩阵
- **AND** 坐标转换必须保持精度和一致性
- **AND** 必须处理不同缩放级别下的坐标计算

## MODIFIED Requirements

### Requirement: 画布交互事件处理

系统 SHALL 扩展现有的画布交互处理，支持右键菜单和坐标捕获功能。

#### Scenario: 多种交互方式共存

- **WHEN** 用户在画布上进行不同类型的交互时
- **THEN** 左键点击必须继续触发节点选择和编辑功能
- **AND** 右键点击必须触发上下文菜单而不是选择节点
- **AND** 拖拽操作必须保持原有的节点移动和连接功能
- **AND** 键盘快捷键必须继续正常工作

#### Scenario: 事件冲突处理

- **WHEN** 处理重叠的事件监听器时
- **THEN** 系统必须正确区分左键和右键事件
- **AND** 右键事件必须阻止浏览器默认的上下文菜单
- **AND** 事件处理必须有明确的优先级顺序
- **AND** 不能影响现有的节点操作功能

#### Scenario: 性能优化

- **WHEN** 处理画布交互事件时
- **THEN** 坐标计算和菜单显示必须保持响应性能
- **AND** 事件处理函数必须进行防抖处理避免重复触发
- **AND** 菜单组件必须使用高效的渲染方式
- **AND** 不能影响画布的主要渲染性能
