# Node Child Comments Feature

## 概述

本提案旨在为画板中的节点添加子评论功能，允许用户通过节点右侧的"+"按钮创建层级化的评论结构，并自动建立父子节点间的连接线，支持无限层级的嵌套评论。

## Why

### 业务需求

1. **层级化讨论需求**：当前画板只支持平级节点，无法表达讨论的层级关系和回复结构
2. **用户体验提升**：通过直观的"+"按钮操作，降低用户创建子评论的认知负担
3. **内容组织优化**：支持父子关系的内容组织，让信息结构更清晰、更有逻辑性

### 技术需求

1. **功能扩展性**：为现有节点系统添加层级化支持，为未来更复杂的图结构奠定基础
2. **交互设计优化**：设计符合用户心智模型的子节点创建交互流程
3. **视觉层次表达**：通过不同的视觉样式区分父子节点层级关系

## What Changes

### 核心功能变更

- **Board.tsx**：
  - 扩展节点数据结构，支持父子关系
  - 添加自定义节点类型，集成"+"按钮功能
  - 实现子节点创建和连接逻辑

- **新增 CustomNode 组件**：
  - 渲染带"+"按钮的节点界面
  - 处理"+"按钮点击事件
  - 区分父子节点的视觉样式

- **RightSidebar.tsx**：
  - 扩展侧边栏模式，支持"子评论创建"模式
  - 添加父节点信息显示

- **连接线管理**：
  - 自动建立父子节点间的连接线
  - 支持多层级的连接关系

### 视觉设计变更

- **节点样式差异化**：
  - 父节点：当前标准尺寸和颜色
  - 子节点：较小尺寸，使用不同的背景色或边框色
  - 连接线：清晰的父子关系指示

- **"+"按钮设计**：
  - 位置：节点右侧固定位置
  - 样式：小型圆形按钮，"+"图标
  - 状态：始终可见，悬停时有视觉反馈

### 交互流程变更

- **子节点创建流程**：
  1. 用户点击节点右侧的"+"按钮
  2. 右侧边栏展开，显示"添加子评论"表单
  3. 用户填写评论内容并保存
  4. 自动创建子节点并建立连接线
  5. 子节点相对于父节点自动定位

- **布局管理**：
  - 使用ReactFlow的自动布局算法
  - 支持拖拽调整子节点位置
  - 保持连接线的动态更新

## 技术实现要点

### 节点数据结构扩展

```typescript
interface ExtendedNodeData extends NodeData {
  parentId?: string; // 父节点ID
  level?: number; // 节点层级
  childIds?: string[]; // 子节点ID列表
}
```

### 自定义节点组件

- 创建带有"+"按钮的自定义节点类型
- 实现父子节点的差异化渲染
- 处理按钮交互事件

### 连接线管理

- 自动创建父子节点间的连接线
- 支持连接线的样式定制
- 维护连接线与节点数据的一致性

### 侧边栏扩展

- 添加"子评论创建"模式
- 显示父节点上下文信息
- 优化表单体验

## 预期成果

### 功能性成果

- ✅ 节点右侧显示"+"按钮
- ✅ 点击"+"按钮可创建子评论节点
- ✅ 自动建立父子节点连接线
- ✅ 支持无限层级的嵌套结构
- ✅ 子节点使用差异化视觉样式
- ✅ 保持现有功能的完整性

### 用户体验成果

- ✅ 直观的子评论创建操作
- ✅ 清晰的层级关系视觉表达
- ✅ 流畅的交互体验
- ✅ 响应式的布局管理

## 风险与缓解

### 潜在风险

1. **布局复杂性**：多层级节点可能导致布局混乱
   - **缓解措施**：使用ReactFlow的自动布局算法，提供手动调整选项

2. **性能影响**：大量节点和连接线可能影响渲染性能
   - **缓解措施**：实现虚拟化渲染，优化连接线计算

3. **用户认知负担**：新功能可能增加学习成本
   - **缓解措施**：提供清晰的用户引导和帮助信息

## 实施范围

### 包含内容

- Board.tsx 的节点系统扩展
- 自定义节点组件开发
- RightSidebar.tsx 的模式扩展
- 连接线管理逻辑
- 相关测试用例

### 不包含内容

- 节点删除功能变更
- 连接线的复杂交互编辑
- 协作冲突处理
- 性能优化方案

---

**提案ID**: `node-child-comments`
**创建日期**: 2025-11-19
**预估工作量**: 中等
**优先级**: 高
