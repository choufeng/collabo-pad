# Board Child Comments Specification

## Purpose

定义画板节点子评论功能的技术规范，包括自定义节点组件、层级化节点管理、连接线处理和用户交互流程。

## ADDED Requirements

### Requirement: 节点子评论功能

系统 SHALL 为每个节点提供添加子评论的功能，支持层级化的内容组织结构。

#### Scenario: 节点右侧显示添加按钮

- **WHEN** 用户查看画板上的任何节点时
- **THEN** 节点右侧必须显示一个"+"按钮
- **AND** 按钮必须始终可见，不受悬停状态影响
- **AND** 按钮样式必须清晰可识别
- **AND** 按钮位置必须相对于节点固定，不随缩放变化

#### Scenario: 点击添加按钮打开子评论侧边栏

- **WHEN** 用户点击节点右侧的"+"按钮
- **THEN** 右侧边栏必须展开，显示"添加子评论"界面
- **AND** 侧边栏标题必须显示"Add Child Comment"
- **AND** 必须显示父节点的内容作为上下文参考
- **AND** 表单焦点必须自动设置到内容输入框

#### Scenario: 创建子评论节点

- **WHEN** 用户在"添加子评论"侧边栏中填写内容并点击保存
- **THEN** 必须在画板上创建新的子节点
- **AND** 子节点必须自动与父节点建立连接线
- **AND** 子节点必须使用与父节点不同的视觉样式
- **AND** 子节点位置必须相对于父节点自动计算
- **AND** 侧边栏必须自动关闭

#### Scenario: 多层级子评论支持

- **WHEN** 用户在子节点上点击"+"按钮
- **THEN** 必须能够创建更深层级的子节点
- **AND** 必须支持无限层级的嵌套结构
- **AND** 每个层级都必须保持清晰的视觉区分
- **AND** 连接线必须正确显示层级关系

### Requirement: 自定义节点组件

系统 SHALL 实现自定义节点组件，支持"+"按钮集成和差异化样式渲染。

#### Scenario: 父节点样式渲染

- **WHEN** 渲染没有父节点的顶级节点时
- **THEN** 节点必须使用当前的标准尺寸和样式
- **AND** 节点右侧必须显示"+"按钮
- **AND** 节点颜色必须使用标准的蓝色主题
- **AND** 节点边框必须清晰可见

#### Scenario: 子节点样式渲染

- **WHEN** 渲染有父节点的子节点时
- **THEN** 节点尺寸必须比父节点小20%
- **AND** 节点颜色必须使用不同的主题色（如绿色或橙色）
- **AND** 节点边框样式必须与父节点区分
- **AND** 节点右侧也必须显示"+"按钮

#### Scenario: 添加按钮交互

- **WHEN** 用户鼠标悬停在"+"按钮上时
- **THEN** 按钮必须有明显的悬停效果
- **AND** 按钮颜色必须有视觉变化
- **AND** 鼠标指针必须变为手型指针
- **AND** 可以显示工具提示"Add child comment"

#### Scenario: 添加按钮状态管理

- **WHEN** 侧边栏正在处理子节点创建时
- **THEN** 对应的"+"按钮必须显示加载状态
- **AND** 按钮必须被禁用，防止重复点击
- **AND** 其他节点的"+"按钮保持正常状态
- **AND** 创建完成后按钮恢复正常状态

### Requirement: 连接线自动管理

系统 SHALL 自动管理父子节点间的连接线，保持层级关系的可视化表达。

#### Scenario: 自动创建连接线

- **WHEN** 子节点创建成功时
- **THEN** 必须自动创建从父节点到子节点的连接线
- **AND** 连接线必须使用合适的样式（如箭头指向子节点）
- **AND** 连接线颜色必须与节点主题协调
- **AND** 连接线必须保持清晰的路径

#### Scenario: 连接线样式定制

- **WHEN** 显示父子节点连接时
- **THEN** 连接线必须使用平滑的曲线样式
- **AND** 连接线宽度必须适中，避免过于突兀
- **AND** 连接线颜色必须与层级关系匹配
- **AND** 连接线必须有动画效果，提升用户体验

#### Scenario: 多层级连接线管理

- **WHEN** 存在多层级的节点结构时
- **THEN** 连接线必须清晰显示每层级的父子关系
- **AND** 不同层级的连接线可以使用不同的样式区分
- **AND** 连接线必须避免交叉和混乱
- **AND** 支持手动调整连接线路径

### Requirement: 节点数据结构扩展

系统 SHALL 扩展节点数据结构，支持层级化信息管理。

#### Scenario: 父子关系数据存储

- **WHEN** 创建子节点时
- **THEN** 子节点数据必须包含父节点ID
- **AND** 父节点数据必须更新子节点ID列表
- **AND** 节点数据必须包含层级深度信息
- **AND** 数据结构必须支持快速查找父子关系

#### Scenario: 节点层级计算

- **WHEN** 节点加载或更新时
- **THEN** 必须自动计算节点的层级深度
- **AND** 顶级节点层级为0，子节点层级递增
- **AND** 层级信息必须用于节点样式渲染
- **AND** 层级变更必须触发相关节点更新

#### Scenario: 节点关系验证

- **WHEN** 进行节点操作时
- **THEN** 必须验证父子关系的有效性
- **AND** 不能创建循环引用的父子关系
- **AND** 删除父节点时必须处理子节点关系
- **AND** 关系变更必须保持数据一致性

### Requirement: 侧边栏模式扩展

系统 SHALL 扩展右侧边栏，支持子评论创建模式。

#### Scenario: 子评论创建模式

- **WHEN** 用户点击"+"按钮打开侧边栏时
- **THEN** 侧边栏必须进入"child-comment"模式
- **AND** 标题必须显示"Add Child Comment"
- **AND** 必须显示父节点内容的预览
- **AND** 表单提交按钮必须显示"Add Comment"

#### Scenario: 父节点上下文显示

- **WHEN** 侧边栏处于子评论创建模式时
- **THEN** 必须在侧边栏顶部显示父节点信息
- **AND** 父节点内容预览必须可读但不编辑
- **AND** 必须显示"Replying to: [父节点内容摘要]"
- **AND** 上下文信息必须帮助用户理解回复关系

#### Scenario: 子评论表单验证

- **WHEN** 用户在子评论模式下提交表单时
- **THEN** 必须验证评论内容不能为空
- **AND** 子评论内容长度不能超过500字符
- **AND** 验证失败时必须显示清晰的错误提示
- **AND** 验证通过时才能创建子节点

## MODIFIED Requirements

### Requirement: 节点类型系统

系统 SHALL 扩展节点类型系统，支持自定义节点组件的集成。

#### Scenario: 自定义节点类型注册

- **WHEN** 画板初始化时
- **THEN** 必须注册带有"+"按钮的自定义节点类型
- **AND** 节点类型必须支持差异化样式渲染
- **AND** 节点类型必须支持交互事件处理
- **AND** 节点类型必须与现有系统兼容

#### Scenario: 默认节点类型保持

- **WHEN** 创建新的顶级节点时
- **THEN** 必须使用标准的节点类型
- **AND** 标准节点必须包含"+"按钮功能
- **AND** 现有节点的功能必须保持不变
- **AND** 用户界面必须保持一致性

## 实施注意事项

### 性能考虑

- 必须优化大量节点的渲染性能
- 连接线计算必须高效，避免阻塞UI
- 节点数据更新必须使用批量操作

### 兼容性考虑

- 必须保持现有节点功能的完整性
- 新功能不能影响现有的连接线操作
- 必须支持现有的导入导出功能

### 可用性考虑

- "+"按钮必须足够大，易于点击
- 必须支持键盘导航
- 必须提供清晰的视觉反馈
