## Purpose

修复节点位置更新后的实时同步问题，确保当用户拖动节点位置后，其他协作用户能够实时看到位置变化，提升多用户协作体验。

## Requirements

### Requirement: 主题更新事件实时广播

系统 MUST 在主题更新时通过 Redis Stream 和 SSE 实时广播变更事件给所有连接的客户端。

#### Scenario: 节点位置更新触发广播

- **WHEN** 用户拖动节点位置并通过 `/api/topics/update` 更新数据库
- **THEN** 系统必须在数据库更新成功后发布 `topic_updated` 事件到 Redis Stream
- **AND** 事件必须包含完整的主题更新信息（ID、新位置、更新时间戳）
- **AND** SSE 服务器必须立即将事件推送给所有相关频道的连接客户端
- **AND** 广播延迟不得超过 500 毫秒

#### Scenario: SSE 消息类型扩展

- **WHEN** SSE 客户端接收到 `topic_updated` 类型的消息
- **THEN** 客户端必须正确解析消息并更新本地主题状态
- **AND** 必须根据主题 ID 找到并更新对应的节点位置信息
- **AND** 如果主题不存在于本地状态，必须将其添加到主题列表中
- **AND** 更新操作必须保持其他主题信息的完整性

### Requirement: 并发更新冲突处理

系统 MUST 正确处理多用户同时编辑同一主题位置时的并发冲突。

#### Scenario: 基于时间戳的冲突解决

- **WHEN** 系统接收到多个对同一主题的位置更新请求
- **THEN** 必须使用时间戳作为冲突解决依据
- **AND** 较新的更新必须覆盖较旧的更新
- **AND** 如果时间戳相同，必须保留最后一次到达的有效更新
- **AND** 被覆盖的更新必须记录到日志中用于调试

#### Scenario: 乐观锁机制

- **WHEN** 客户端发送位置更新请求
- **THEN** 请求必须包含当前主题的最后已知时间戳
- **AND** 服务器必须验证时间戳与数据库中的一致性
- **AND** 如果时间戳不匹配，必须拒绝更新并返回当前最新状态
- **AND** 客户端收到冲突响应后必须合并差异并重试

### Requirement: 网络异常恢复机制

系统 MUST 提供强大的网络异常恢复和数据同步补偿机制。

#### Scenario: 连接断开重连后的状态同步

- **WHEN** 客户端 SSE 连接断开后重新建立
- **THEN** 客户端必须请求获取断开期间的所有主题更新
- **AND** 服务器必须提供增量同步接口返回变更的主题列表
- **AND** 客户端必须应用所有缺失的更新到本地状态
- **AND** 同步完成后必须验证本地状态与服务器状态的一致性

#### Scenario: 消息丢失补偿

- **WHEN** 系统检测到可能的 SSE 消息丢失
- **THEN** 必须触发完整性检查机制
- **AND** 客户端必须请求全量或增量状态同步
- **AND** 必须显示同步状态指示器给用户
- **AND** 同步完成后必须清除指示器并恢复正常状态

### Requirement: 性能优化和防抖机制

系统 MUST 优化实时同步性能并防止频繁的位置更新造成系统负载。

#### Scenario: 智能防抖机制

- **WHEN** 用户连续快速拖动节点位置
- **THEN** 客户端必须使用防抖机制（300ms）减少更新请求频率
- **AND** 必须合并短时间内的多个位置更新为单个请求
- **AND** 防抖结束后必须发送最终的准确位置
- **AND** 期间必须显示临时保存状态给用户

#### Scenario: 批量更新处理

- **WHEN** 服务器在短时间内收到大量位置更新请求
- **THEN** 必须使用批处理机制优化数据库写入性能
- **AND** 必须保持更新的顺序性和一致性
- **AND** 批处理完成后必须立即触发单次 SSE 广播事件
- **AND** 必须设置合理的批处理时间窗口（100ms）

### Requirement: 用户体验反馈机制

系统 MUST 为用户提供清晰的实时同步状态反馈和操作确认。

#### Scenario: 同步状态可视化

- **WHEN** 节点位置正在保存或同步中
- **THEN** 界面必须显示保存状态指示器
- **AND** 必须区分"正在保存"、"已保存"、"同步中"、"同步失败"等状态
- **AND** 指示器必须在操作完成后2秒内自动消失
- **AND** 颜色和动画必须清晰传达当前状态

#### Scenario: 错误反馈和重试选项

- **WHEN** 位置更新或同步失败
- **THEN** 系统必须显示用户友好的错误提示
- **AND** 必须提供手动重试操作的选项
- **AND** 如果网络问题持续，必须提供离线模式提示
- **AND** 错误信息必须包含具体的问题描述和建议的解决方案

## MODIFIED Requirements

### MODIFIED Requirement: 轮询检测机制增强 (extends redis-stream-management:63)

系统必须扩展轮询机制以检测主题更新，而不仅仅是创建。

#### MODIFIED Scenario: 实时监控新消息

- **WHEN** 有新消息被添加到监控的 Stream 中
- **THEN** 系统必须通过 SSE 连接推送新消息
- **AND** 消息类型必须包括 `topic_created`、`topic_updated`、`topic_deleted`
- **AND** 每种消息类型都必须包含完整的主题数据
- **AND** 客户端必须自动更新消息列表并执行相应的本地状态更新
- **AND** 必须显示新消息提醒
- **AND** 必须保持推送的实时性和可靠性

#### ADDED Scenario: 检测主题更新

- **WHEN** 现有主题在数据库中被更新（位置、内容等）
- **THEN** 轮询机制必须检测到 `updatedAt` 时间戳的变化
- **AND** 必须生成 `topic_updated` 类型的SSE消息
- **AND** 消息必须包含更新后的完整主题数据
- **AND** 消息必须包含更新时间戳用于客户端冲突解决

## ADDED Requirements

### Requirement: 向后兼容性保证

系统 MUST 确保新的实时同步功能与现有的创建同步机制完全兼容。

#### Scenario: 现有功能保持不变

- **WHEN** 用户创建新的主题
- **THEN** 现有的创建同步机制必须继续正常工作
- **AND** 新的更新同步机制不能影响现有功能的性能
- **AND** 所有现有的测试用例必须继续通过
- **AND** API 接口必须保持向后兼容

### Requirement: 测试和验证机制

系统 MUST 提供完整的测试覆盖和验证机制确保实时同步功能可靠性。

#### Scenario: 自动化集成测试

- **WHEN** 开发者运行测试套件
- **THEN** 必须包含实时同步功能的端到端测试
- **AND** 必须模拟多用户同时操作场景
- **AND** 必须验证网络异常恢复机制
- **AND** 测试覆盖率必须达到 90% 以上
