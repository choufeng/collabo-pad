# 修复节点位置更新后的实时同步问题

## 问题概述

当前系统存在数据同步不一致的问题：

1. **新topic创建同步正常**：当用户创建新topic时，其他用户可以很快看到新的topic出现
2. **节点位置更新同步缺失**：当用户拖动节点位置后，其他用户的界面没有同步反映这些变化

## 根本原因分析

通过代码分析发现根本原因：

### SSE消息处理不完整

- `use-sse-topics.ts:62-103` 中的SSE消息处理器只处理了以下消息类型：
  - `topic_created`: 新主题创建
  - `history_data`: 历史数据
  - `heartbeat`: 心跳
  - `error`: 错误消息
- **缺少对 `topic_updated` 消息类型的处理**

### 轮询机制只检测创建，不检测更新

- `src/app/api/sse/channel/[channelId]/route.ts:98-155` 使用轮询机制检查数据库变更
- **当前轮询只检查 `createdAt` 时间戳，忽略 `updatedAt`**
- 这意味着新主题会被检测到，但位置更新不会被检测到

### 现有同步流程对比

**创建新topic流程（正常工作）：**

1. 用户调用创建API → 2. 数据库写入（更新createdAt）→ 3. 轮询检测到新主题 → 4. SSE发送topic_created → 5. 前端更新UI

**更新节点位置流程（缺少步骤3-4）：**

1. 用户调用更新API → 2. 数据库写入（更新updatedAt）→ 3. **❌ 轮询忽略updatedAt变更** → 4. **❌ 不发送更新事件** → 5. 其他用户UI不更新

## 技术实现方案

### 1. 轮询机制增强

- 修改 `src/app/api/sse/channel/[channelId]/route.ts` 的轮询逻辑
- 同时检查 `createdAt` 和 `updatedAt` 时间戳
- 为更新操作创建 `topic_updated` 类型的SSE消息

### 2. 前端SSE处理器增强

- 在 `use-sse-topics.ts` 中添加 `topic_updated` 消息类型处理
- 实现现有topic的更新逻辑（而不是添加新topic）

### 3. 用户体验优化

- 确保位置更新使用防抖机制避免频繁更新
- 添加视觉反馈显示同步状态
- 处理并发更新的冲突解决

## 影响范围

- **后端**: `src/app/api/sse/channel/[channelId]/route.ts`
- **前端**: `src/hooks/use-sse-topics.ts`
- **测试**: 需要添加实时同步测试用例
- **文档**: 更新API文档和同步机制说明

## 验收标准

1. ✅ 当用户A拖动节点位置后，用户B能在1-2秒内看到位置变化
2. ✅ 现有的新topic创建同步功能不受影响
3. ✅ 支持多个用户同时编辑的位置冲突处理
4. ✅ 网络断开重连后能正确同步最新状态
5. ✅ 性能测试通过，不影响现有功能响应速度

## 技术债务修复

此修复将解决当前实时协作功能的核心缺陷，确保多用户协作的一致性和用户体验。
