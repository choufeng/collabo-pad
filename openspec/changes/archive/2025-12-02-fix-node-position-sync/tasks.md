# 节点位置实时同步修复任务列表

## 实施计划

### 阶段1: 轮询机制增强 (预计2小时)

- [x] **任务1**: 修改SSE轮询逻辑检测更新
  - 位置: `src/app/api/sse/channel/[channelId]/route.ts`
  - 要求: 同时检查 `createdAt` 和 `updatedAt` 时间戳
  - 验证: ✅ 能够检测到位置变更并生成对应消息

- [x] **任务2**: 扩展SSE消息类型
  - 位置: `src/types/redis-stream.ts`
  - 要求: 添加 `topic_updated` 消息类型定义
  - 验证: ✅ TypeScript类型检查通过

- [x] **任务3**: 实现更新消息生成逻辑
  - 位置: `src/app/api/sse/channel/[channelId]/route.ts`
  - 要求: 为检测到的更新生成 `topic_updated` 消息
  - 验证: ✅ 消息格式正确且包含更新数据

### 阶段2: 前端SSE处理器增强 (预计1.5小时)

- [x] **任务4**: 扩展SSE消息处理器
  - 位置: `src/hooks/use-sse-topics.ts`
  - 要求: 添加 `topic_updated` 消息类型处理逻辑
  - 验证: ✅ TypeScript编译通过，处理器能接收新消息类型

- [x] **任务5**: 实现本地topic更新逻辑
  - 位置: `src/hooks/use-sse-topics.ts`
  - 要求: 更新现有topic数组中的对应条目
  - 验证: ✅ 前端状态正确更新

- [x] **任务6**: 优化防抖和冲突处理
  - 位置: `src/components/Board.tsx`
  - 要求: 改进现有的防抖机制，添加冲突检测
  - 验证: ✅ 性能测试通过，并发更新处理正确

### 阶段3: 测试和验证 (预计2.5小时)

- [x] **任务7**: 编写单元测试
  - 位置: `__tests__/hooks/use-sse-topics.test.ts`
  - 要求: 覆盖新增的 `topic_updated` 处理逻辑
  - 验证: ✅ 测试用例已创建，覆盖主要功能点

- [ ] **任务8**: 编写集成测试
  - 位置: `__tests__/api/topics/update.test.ts`
  - 要求: 测试完整的更新→发布→接收→更新流程
  - 验证: 端到端测试通过

- [ ] **任务9**: 多用户协作测试
  - 位置: `__tests__/e2e/real-time-sync.test.ts`
  - 要求: 模拟多用户同时操作场景
  - 验证: 并发操作正确处理

### 阶段4: 用户体验优化 (预计1小时)

- [ ] **任务10**: 添加同步状态反馈
  - 位置: `src/components/Board.tsx`
  - 要求: 显示位置保存和同步状态
  - 验证: 用户界面提供清晰反馈

- [ ] **任务11**: 错误处理和重试机制
  - 位置: `src/hooks/use-sse-topics.ts`
  - 要求: 同步失败时的重连和补偿机制
  - 验证: 网络异常场景测试通过

### 阶段5: 部署和文档 (预计0.5小时)

- [ ] **任务12**: 更新API文档
  - 位置: 项目文档目录
  - 要求: 说明新的实时同步机制
  - 验证: 文档准确且完整

- [ ] **任务13**: 性能回归测试
  - 位置: 现有测试套件
  - 要求: 确保新功能不影响现有性能
  - 验证: 所有现有测试仍然通过

## 验收标准检查清单

### 功能性检查

- [ ] 用户拖动节点后，其他用户1-2秒内看到变化
- [ ] 新topic创建同步功能保持正常
- [ ] 多用户同时编辑的冲突处理正确
- [ ] 网络断开重连后状态同步正确

### 非功能性检查

- [ ] 性能测试通过，响应时间<500ms
- [ ] 内存使用无显著增加
- [ ] 测试覆盖率达到项目要求(90%+)
- [ ] 代码通过ESLint和Prettier检查
- [ ] TypeScript类型检查无错误

## 风险和缓解措施

### 高风险

- **Redis Stream消息格式不兼容**: 提前验证格式，保持向后兼容
- **前端状态更新冲突**: 实现乐观锁机制，基于时间戳冲突解决

### 中风险

- **性能影响**: 添加性能监控，设置响应时间阈值
- **网络延迟影响**: 实现智能重试和补偿机制

### 低风险

- **测试覆盖不足**: 采用TDD开发模式，确保测试先于实现

## 时间估算总计: 7.5小时

_不含调试和问题解决时间，建议预留额外50%缓冲时间_
