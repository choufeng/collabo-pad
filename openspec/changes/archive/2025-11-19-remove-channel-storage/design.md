# 频道存储移除的设计方案

## 当前架构分析

### 现有流程

```
首页面填写频道ID → 创建Channel记录 → 存储到IndexedDB → 跳转到/board/{id}
                                    ↓
画板页面验证频道存在性 ← 从IndexedDB查询 ← 验证用户权限
```

### 存在的问题

1. **数据冗余**: 频道信息同时存在于URL和IndexedDB中
2. **复杂验证**: 需要数据库查询来验证频道存在性和权限
3. **存储浪费**: 为临时使用的频道ID创建持久化记录
4. **权限限制**: 频道访问受用户限制，不符合协作场景

## 目标架构

### 简化后流程

```
首页面填写频道ID → 验证用户登录 → 直接跳转到/board/{id}
                                    ↓
画板页面验证用户状态 + 频道ID格式 → 显示画板
```

### 核心变更

1. **移除频道持久化**: 不再在IndexedDB中存储频道信息
2. **简化验证逻辑**: 只验证用户登录状态和频道ID格式
3. **开放频道访问**: 任何登录用户都可以访问任何频道ID
4. **URL作为唯一标识**: 频道ID仅在URL中使用，作为画板的标识符

## 详细设计

### 1. 数据层变更

#### 删除的文件/类型

- `src/database/channel-data-service.ts` - 完全删除
- `Channel` 接口 - 从 `types.ts` 中删除
- `channels` 表 - 从数据库模式中删除
- 频道相关的测试文件

#### 保留的文件/类型

- `User` 接口 - 保持不变
- `UserSession` 接口 - 保持不变
- 用户数据服务 - 保持不变

### 2. 状态管理变更

#### 删除的状态

- `useChannelStore` - 完全删除
- `currentChannel` 状态
- 频道相关的loading和error状态

#### 简化的组件

- 首页面不再需要频道状态管理
- 画板页面只使用用户状态管理

### 3. 组件变更

#### 首页面 (`src/components/home-page.tsx`)

```typescript
// 删除前
const channel = await createChannel({ id: formData.channelId.trim() });
router.push(`/board/${channel.id}`);

// 删除后
await createOrGetUser(formData.username.trim());
router.push(`/board/${formData.channelId.trim()}`);
```

#### 画板页面 (`src/app/[channel-id]/page.tsx`)

```typescript
// 删除前
const channel = await databaseService.getChannel(channelId);
if (!channel || channel.userId !== session.currentUserId) {
  // 权限验证失败
}

// 删除后
if (!currentUser) {
  // 只需验证用户登录状态
  router.push("/");
}
```

### 4. 路由和验证

#### 频道ID格式验证

- 保留现有的格式验证: `/^[a-zA-Z0-9]+$/`
- 在画板页面直接验证URL参数
- 无需数据库查询验证

#### 用户状态验证

- 保留现有的用户登录验证
- 使用简化的用户数据服务
- 确保用户已创建即可访问画板

## 实施步骤

1. **第一阶段**: 移除频道数据服务和类型
2. **第二阶段**: 简化首页面逻辑
3. **第三阶段**: 简化画板页面验证
4. **第四阶段**: 删除频道状态管理
5. **第五阶段**: 更新和清理测试用例

## 兼容性考虑

### 数据迁移

- 现有频道数据可以安全删除
- 不会影响用户数据
- 不会影响画板核心功能

### 向后兼容

- URL结构保持不变
- 用户界面操作保持一致
- 画板功能完全保留

## 测试策略

### 需要删除的测试

- 频道数据服务测试
- 频道状态管理测试
- 频道创建和验证测试

### 需要更新的测试

- 首页面集成测试
- 画板页面路由测试
- 用户状态管理测试

### 新增测试

- 频道ID格式验证测试
- 开放频道访问测试
- 简化流程的端到端测试

## 性能影响

### 预期改进

- **数据库操作**: 减少100%的频道相关查询
- **页面加载**: 消除频道验证延迟
- **存储空间**: 减少IndexedDB使用量
- **代码复杂度**: 显著降低相关代码复杂度

### 测量指标

- 首页面到画板页面的跳转时间
- 画板页面的首次加载时间
- IndexedDB存储空间使用量
- 相关测试套件的执行时间
