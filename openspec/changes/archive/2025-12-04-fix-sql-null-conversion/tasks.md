# 空值转换实现任务列表

## 核心工具开发

### 1. 创建空值转换工具函数

- [x] 创建 `src/utils/null-conversion.ts` 文件
- [x] 实现 `toNull()` 工具函数，支持泛型
- [x] 实现 `toNullObject()` 函数，处理对象字段批量转换
- [x] 添加完整的 JSDoc 注释和使用示例
- [x] 编写单元测试，覆盖所有边界情况

### 2. 测试驱动开发

- [x] 创建 `src/utils/__tests__/null-conversion.test.ts` 文件
- [x] 编写 `toNull()` 函数的测试用例（空字符串、undefined、null、正常值）
- [x] 编写 `toNullObject()` 函数的测试用例（嵌套对象、数组、混合类型）
- [x] 确保测试覆盖率达到 100%

## Redis 集成

### 3. 修改 Redis 流操作

- [x] 修改 `src/lib/redis.ts` 中的 `addToStream()` 方法
- [x] 在 `Object.entries()` 前添加空值过滤逻辑
- [x] 更新 `updateMessage()` 方法的参数处理
- [x] 确保 Redis 流消息不包含空字段

### 4. Redis 操作集成测试

- [x] 创建 Redis 空值处理的集成测试
- [x] 验证空值不会被写入 Redis 流
- [x] 验证现有 Redis 功能不受影响

## TopicService 集成

### 5. 更新 TopicService

- [x] 修改 `src/services/TopicService.ts` 的 `create()` 方法
- [x] 在数据库操作前添加空值转换
- [x] 修改 `update()` 方法，确保空值正确处理
- [x] 保持现有 API 接口不变

### 6. API 验证层增强

- [x] 更新 `src/app/api/topic/create/route.ts` 的数据处理逻辑
- [x] 修改 `src/app/api/topics/update/route.ts` 的验证逻辑
- [x] 确保坐标字段（x, y）正确转换
- [x] 确保尺寸字段（w, h）正确转换

## 测试和验证

### 7. 端到端测试

- [x] 编写 API 端到端测试，验证空值转换不影响业务逻辑
- [x] 测试创建主题时的空值处理
- [x] 测试更新主题时的空值处理
- [x] 验证 API 响应格式的稳定性

### 8. 性能和兼容性测试

- [x] 验证空值转换不影响现有性能
- [x] 确保向后兼容性
- [x] 测试边界情况和异常处理

## 文档和清理

### 9. 代码文档

- [x] 更新相关函数的 JSDoc 注释
- [x] 添加空值转换使用指南
- [x] 更新 API 文档中的字段说明

### 10. 代码审查和重构

- [x] 移除重复的空值处理逻辑
- [x] 统一代码风格
- [x] 进行最终的代码审查

## 验收标准

- [x] 所有空字符串和 undefined 值在存储前转为 null
- [x] 现有功能完全不受影响
- [x] 单元测试覆盖率达到 100%
- [x] 集成测试通过
- [x] 性能测试通过
- [x] 代码审查通过

## 风险和注意事项

- **向后兼容性**: 确保现有客户端代码不受影响
- **性能影响**: 空值转换不应显著影响 API 响应时间
- **数据一致性**: 验证数据库中的数据格式一致性
- **测试覆盖**: 确保所有边界情况都有测试覆盖
