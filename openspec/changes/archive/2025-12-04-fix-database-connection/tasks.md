# 数据库连接修复任务清单

## 任务列表

### 阶段 1: 环境变量统一修复

1. **统一数据库连接环境变量解析逻辑**
   - 修改 `src/database/drizzle.ts`：实现统一的环境变量优先级
   - 修改 `drizzle.config.ts`：使用相同的环境变量解析逻辑
   - 添加环境变量解析的日志记录（脱敏）

2. **修复健康检查数据库验证**
   - 修改 `src/app/api/health/route.ts`：使用统一的数据库连接逻辑
   - 改进错误状态报告和调试信息
   - 添加连接延迟测量

3. **更新环境变量配置文件**
   - 更新 `.env.local.example`：添加清晰的配置示例和注释
   - 确保 `.env` 和 `.env.local` 的一致性
   - 添加配置验证和说明文档

### 阶段 2: 连接验证增强

4. **实现启动时数据库连接验证**
   - 在 `src/database/drizzle.ts` 中添加启动时健康检查
   - 实现异步连接验证，不阻塞应用启动
   - 添加详细的错误日志和故障排除建议

5. **增强错误处理和日志**
   - 改进数据库连接错误的日志格式
   - 添加连接重试逻辑（可选）
   - 确保敏感信息不被记录到日志中

### 阶段 3: 验证和测试

6. **测试修复效果**
   - 验证健康检查 API 正确报告数据库状态
   - 测试主题服务能够正常查询数据
   - 确认环境变量在不同配置下都能正确工作

7. **创建测试用例**
   - 为数据库连接逻辑编写单元测试
   - 为健康检查 API 编写集成测试
   - 测试环境变量优先级逻辑

8. **文档更新**
   - 更新 README.md 包含数据库配置说明
   - 添加故障排除指南
   - 更新开发环境设置说明

## 验收测试

### 功能测试

- [x] 健康检查显示数据库连接状态为 "ok"
- [x] 主题服务 `findByChannelId` 正常返回数据
- [x] 环境变量优先级按预期工作
- [x] 错误日志提供有用的调试信息

### 配置测试

- [x] 使用 `DATABASE_URL` 配置正常工作
- [x] 使用 `POSTGRES_URL` 配置正常工作
- [ ] 缺少数据库配置时正确显示 "not_configured"
- [ ] 数据库连接失败时正确显示 "error"

### 部署测试

- [x] 本地开发环境配置正常
- [ ] Docker 容器环境配置正常
- [ ] 生产环境配置模板正确

## 风险缓解

### 回滚计划

- 保留当前配置文件的备份
- 准备快速回滚脚本
- 分阶段实施，每阶段都可独立回滚

### 测试策略

- 在开发环境充分测试后再部署
- 准备监控和告警机制
- 验证现有功能不受影响

## 依赖关系

- **前置依赖**：无
- **阻塞功能**：data-storage, topic-management
- **相关功能**：deployment, testing

## 预期时间线

每个阶段预计 1-2 天：

- 阶段 1：核心修复（1-2 天）
- 阶段 2：增强功能（1 天）
- 阶段 3：验证测试（1 天）

总计：3-4 天完成所有修复
