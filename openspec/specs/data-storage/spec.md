## Purpose

定义应用的数据存储策略和架构，包括用户数据、频道数据和会话管理的完整持久化方案，确保数据的一致性、可靠性和性能。

## Requirements

### Requirement: 数据持久化基础

系统 MUST 提供可靠的数据持久化机制，确保用户数据在浏览器会话之间保持一致。

#### Scenario: 基础存储能力

- **WHEN** 应用需要存储数据时
- **THEN** 系统必须使用 IndexedDB 作为主要存储机制
- **AND** 必须提供数据备份和恢复机制
- **AND** 必须处理存储容量限制和错误情况

### Requirement: 数据存储架构

数据存储层 MUST 简化为只包含必要的操作，移除过度设计的功能。

#### Scenario: 简化的数据库结构

- **WHEN** 设计数据库表结构时
- **THEN** 用户表必须只包含 id、username、createdAt 字段
- **AND** 必须移除 updatedAt 字段（不需要更新操作）
- **AND** 必须保持与现有频道管理的兼容性
- **AND** 必须确保数据的原子性操作

#### Scenario: 简化的数据操作接口

- **WHEN** 定义数据服务接口时
- **THEN** 必须只提供 createOrGetUser 和 getCurrentUser 方法
- **AND** 必须移除 getUser、getUserByUsername、updateUser、deleteUser 方法
- **AND** 必须保持接口的简洁性和易用性
- **AND** 必须提供清晰的类型定义

#### Scenario: 简化的会话管理

- **WHEN** 管理用户会话时
- **THEN** 会话表必须只包含 currentUserId 和 lastActiveAt 字段
- **AND** 必须移除 currentChannelId 字段（移至频道管理）
- **AND** 必须确保会话数据的自动更新
- **AND** 必须支持会话的快速恢复

### Requirement: 测试用例简化

测试规范 MUST 移除不必要的测试用例，专注于核心功能验证。

#### Scenario: 核心功能测试

- **WHEN** 编写数据库服务测试时
- **THEN** 必须测试用户创建功能
- **AND** 必须测试用户获取功能
- **AND** 必须测试重复创建的处理
- **AND** 必须移除所有 CRUD 操作的过度测试

#### Scenario: Mock 简化

- **WHEN** 创建测试 Mock 对象时
- **THEN** 必须简化 Mock 实现，只模拟必要的方法
- **AND** 必须移除复杂的 Dexie Mock 逻辑
- **AND** 必须使用简单的内存数据结构
- **AND** 必须确保 Mock 的性能和可靠性

### Requirement: 简化的用户数据服务

系统 SHALL 提供简化的用户数据管理服务，专注于实际使用场景。

#### Scenario: 自动用户创建

- **WHEN** 用户首次输入用户名时
- **THEN** 系统必须自动创建用户记录
- **AND** 必须为用户生成唯一的 UUID 标识符
- **AND** 必须存储用户名和创建时间
- **AND** 用户创建操作必须是幂等的

#### Scenario: 用户数据获取

- **WHEN** 应用启动或需要获取当前用户时
- **THEN** 系统必须提供获取当前用户的方法
- **AND** 必须从 IndexedDB 中恢复用户数据
- **AND** 如果没有用户数据必须返回 null
- **AND** 获取操作必须是快速和高效的

#### Scenario: 用户数据持久化

- **WHEN** 用户数据发生变化时
- **THEN** 系统必须自动将数据持久化到 IndexedDB
- **AND** 必须确保数据的完整性和一致性
- **AND** 必须支持应用重启后的数据恢复
- **AND** 必须提供简单的错误处理机制

### Requirement: 统一数据库连接环境变量解析

应用程序 **MUST** 使用一致的环境变量优先级来解析数据库连接字符串。

#### Scenario: 应用程序启动时解析环境变量

当应用程序启动时，系统必须按照以下优先级顺序解析数据库连接字符串：

1. `DATABASE_URL`（最高优先级）
2. `POSTGRES_URL`（备选项）
3. `POSTGRES_URL_NON_POOLING`（最后备选）

### Requirement: 修复健康检查数据库连接验证

健康检查 API **MUST** 正确验证数据库连接状态并报告详细的健康信息。

#### Scenario: 健康检查 API 被调用

当客户端调用 `/api/health` 端点时，系统必须：

- 使用与数据库服务相同的环境变量解析逻辑
- 执行实际的数据库连接测试
- 提供准确的服务状态（ok/error/not_configured）
- 包含连接延迟信息（当连接成功时）
- 不暴露敏感的连接信息

### Requirement: 数据库连接启动验证

应用程序 **MUST** 在启动时验证数据库连接的可用性，并在连接失败时提供明确的错误信息。

#### Scenario: 应用程序启动

当 Next.js 应用程序启动时，系统必须：

- 在后台验证数据库连接
- 如果连接失败，记录详细的错误日志
- 应用程序继续启动，但标记数据库状态为不可用
- 在健康检查中反映真实状态

### Requirement: 环境变量配置管理

环境变量文件 **MUST** 提供一致的数据库配置选项。

#### Scenario: 开发者配置数据库连接

开发者在设置本地开发环境时，必须能够：

- 使用标准的 `DATABASE_URL` 环境变量
- 继续使用现有的 `POSTGRES_URL` 作为备选项
- 在 `.env.example` 文件中找到清晰的配置示例

## ADDED Requirements

### Requirement: 统一数据库连接环境变量解析

应用程序 **MUST** 使用一致的环境变量优先级来解析数据库连接字符串。

#### Scenario: 应用程序启动时解析环境变量

当应用程序启动时，系统必须按照以下优先级顺序解析数据库连接字符串：

1. `DATABASE_URL`（最高优先级）
2. `POSTGRES_URL`（备选项）
3. `POSTGRES_URL_NON_POOLING`（最后备选）

**验证标准**：

- 在 `src/database/drizzle.ts` 中实现统一的解析逻辑
- 在 `drizzle.config.ts` 中使用相同的环境变量优先级
- 在开发日志中记录实际使用的连接字符串（敏感信息脱敏）

### Requirement: 修复健康检查数据库连接验证

健康检查 API **MUST** 正确验证数据库连接状态并报告详细的健康信息。

#### Scenario: 健康检查 API 被调用

当客户端调用 `/api/health` 端点时，系统必须：

- 使用与数据库服务相同的环境变量解析逻辑
- 执行实际的数据库连接测试
- 提供准确的服务状态（ok/error/not_configured）
- 包含连接延迟信息（当连接成功时）
- 不暴露敏感的连接信息

**验证标准**：

- 健康检查返回准确的数据库状态
- 当数据库未配置时，状态为 "not_configured"
- 当数据库连接失败时，状态为 "error"
- 包含足够的调试信息用于故障排除

### Requirement: 数据库连接启动验证

应用程序 **MUST** 在启动时验证数据库连接的可用性，并在连接失败时提供明确的错误信息。

#### Scenario: 应用程序启动

当 Next.js 应用程序启动时，系统必须：

- 在后台验证数据库连接
- 如果连接失败，记录详细的错误日志
- 应用程序继续启动，但标记数据库状态为不可用
- 在健康检查中反映真实状态

**验证标准**：

- 启动时异步验证数据库连接
- 连接失败时应用程序不会崩溃
- 错误日志包含具体的失败原因和故障排除建议
