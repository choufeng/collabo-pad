## Purpose

提供基于 ReactFlow 的交互式画板功能，支持节点的创建、编辑、连接和管理，通过右侧边栏提供更流畅的用户体验。
## Requirements
### Requirement: 右侧边栏交互

系统 SHALL 提供一个右侧可展开的边栏，用于节点的创建和编辑。

#### Scenario: 点击创建节点按钮展开边栏

- **WHEN** 用户点击"创建节点"按钮
- **THEN** 右侧边栏展开，显示节点编辑表单
- **AND** 画布区域自动调整宽度适应边栏

#### Scenario: 在边栏中创建节点

- **WHEN** 用户在边栏中填写节点内容并点击保存
- **THEN** 在画布上创建新节点并显示内容
- **AND** 边栏自动收起

#### Scenario: 点击节点查看内容

- **WHEN** 用户点击画布上的已有节点
- **THEN** 右侧边栏展开，显示该节点的内容
- **AND** 用户可以编辑节点内容并保存

#### Scenario: 拖拽连接线创建节点

- **WHEN** 用户从一个节点拖拽连接线到空白区域
- **THEN** 右侧边栏展开，显示新节点创建表单
- **AND** 保存后创建目标节点并建立连接

### Requirement: 边栏布局管理

边栏 MUST 具有固定的尺寸和流畅的展开/收起动画。

#### Scenario: 边栏尺寸规范

- **WHEN** 边栏展开时
- **THEN** 边栏宽度为 500px，高度为全屏高度
- **AND** 不影响画布的核心功能区域

#### Scenario: 边栏动画效果

- **WHEN** 边栏展开或收起时
- **THEN** 提供平滑的过渡动画
- **AND** 动画时长不超过 300ms

### Requirement: 节点创建交互

系统 MUST 修改现有的节点创建流程，从直接创建改为通过边栏创建。

#### Scenario: 创建节点流程变更

- **WHEN** 用户触发节点创建操作
- **THEN** 不再直接在画布上创建节点
- **AND** 必须通过侧边栏完成节点配置后才能创建

#### Scenario: 画布交互保持

- **WHEN** 边栏展开时
- **THEN** 画布仍然可以正常操作（缩放、平移、选择其他节点）
- **AND** 画布响应式调整布局以适应边栏

### Requirement: 节点类型系统

系统 SHALL 扩展节点类型系统，支持自定义节点组件的集成。

#### Scenario: 自定义节点类型注册

- **WHEN** 画板初始化时
- **THEN** 必须注册带有"+"按钮的自定义节点类型
- **AND** 节点类型必须支持差异化样式渲染
- **AND** 节点类型必须支持交互事件处理
- **AND** 节点类型必须与现有系统兼容

#### Scenario: 默认节点类型保持

- **WHEN** 创建新的顶级节点时
- **THEN** 必须使用标准的节点类型
- **AND** 标准节点必须包含"+"按钮功能
- **AND** 现有节点的功能必须保持不变
- **AND** 用户界面必须保持一致性

### Requirement: 节点子评论功能

系统 SHALL 为每个节点提供添加子评论的功能，支持层级化的内容组织结构。

#### Scenario: 节点右侧显示添加按钮

- **WHEN** 用户查看画板上的任何节点时
- **THEN** 节点右侧必须显示一个"+"按钮
- **AND** 按钮必须始终可见，不受悬停状态影响
- **AND** 按钮样式必须清晰可识别
- **AND** 按钮位置必须相对于节点固定，不随缩放变化

#### Scenario: 点击添加按钮打开子评论侧边栏

- **WHEN** 用户点击节点右侧的"+"按钮
- **THEN** 右侧边栏必须展开，显示"添加子评论"界面
- **AND** 侧边栏标题必须显示"Add Child Comment"
- **AND** 必须显示父节点的内容作为上下文参考
- **AND** 表单焦点必须自动设置到内容输入框

#### Scenario: 创建子评论节点

- **WHEN** 用户在"添加子评论"侧边栏中填写内容并点击保存
- **THEN** 必须在画板上创建新的子节点
- **AND** 子节点必须自动与父节点建立连接线
- **AND** 子节点必须使用与父节点不同的视觉样式
- **AND** 子节点位置必须相对于父节点自动计算
- **AND** 侧边栏必须自动关闭

#### Scenario: 多层级子评论支持

- **WHEN** 用户在子节点上点击"+"按钮
- **THEN** 必须能够创建更深层级的子节点
- **AND** 必须支持无限层级的嵌套结构
- **AND** 每个层级都必须保持清晰的视觉区分
- **AND** 连接线必须正确显示层级关系

### Requirement: 自定义节点组件

系统 SHALL 实现自定义节点组件，支持"+"按钮集成和差异化样式渲染。

#### Scenario: 父节点样式渲染

- **WHEN** 渲染没有父节点的顶级节点时
- **THEN** 节点必须使用当前的标准尺寸和样式
- **AND** 节点右侧必须显示"+"按钮
- **AND** 节点颜色必须使用标准的蓝色主题
- **AND** 节点边框必须清晰可见

#### Scenario: 子节点样式渲染

- **WHEN** 渲染有父节点的子节点时
- **THEN** 节点尺寸必须比父节点小20%
- **AND** 节点颜色必须使用不同的主题色（如绿色或橙色）
- **AND** 节点边框样式必须与父节点区分
- **AND** 节点右侧也必须显示"+"按钮

#### Scenario: 添加按钮交互

- **WHEN** 用户鼠标悬停在"+"按钮上时
- **THEN** 按钮必须有明显的悬停效果
- **AND** 按钮颜色必须有视觉变化
- **AND** 鼠标指针必须变为手型指针
- **AND** 可以显示工具提示"Add child comment"

#### Scenario: 添加按钮状态管理

- **WHEN** 侧边栏正在处理子节点创建时
- **THEN** 对应的"+"按钮必须显示加载状态
- **AND** 按钮必须被禁用，防止重复点击
- **AND** 其他节点的"+"按钮保持正常状态
- **AND** 创建完成后按钮恢复正常状态

### Requirement: 连接线自动管理

系统 SHALL 自动管理父子节点间的连接线，保持层级关系的可视化表达，支持基础路径规划和视觉样式优化。

#### Scenario: 自动创建连接线

- **WHEN** 子节点创建成功时
- **THEN** 必须自动创建从父节点到子节点的连接线
- **AND** 连接线必须使用平滑的曲线样式（smoothstep）
- **AND** 连接线颜色必须与整体设计风格协调
- **AND** 连接线必须具有适当的宽度以保持视觉清晰

#### Scenario: 连接线样式层级区分

- **WHEN** 显示不同层级的父子节点连接时
- **THEN** 连接线样式应保持简洁统一
- **AND** 可以使用基本的颜色或透明度变化来区分层级
- **AND** 连接线样式不应过度复杂，保持视觉简洁

#### Scenario: 多层级连接线管理

- **WHEN** 存在多层级的节点结构时
- **THEN** 连接线必须清晰显示每层级的父子关系
- **AND** 连接线应避免不必要的交叉和混乱
- **AND** 连接线路径应保持简洁和直观

### Requirement: 节点数据结构扩展

系统 SHALL 扩展节点数据结构，支持层级化信息管理。

#### Scenario: 父子关系数据存储

- **WHEN** 创建子节点时
- **THEN** 子节点数据必须包含父节点ID
- **AND** 父节点数据必须更新子节点ID列表
- **AND** 节点数据必须包含层级深度信息
- **AND** 数据结构必须支持快速查找父子关系

#### Scenario: 节点层级计算

- **WHEN** 节点加载或更新时
- **THEN** 必须自动计算节点的层级深度
- **AND** 顶级节点层级为0，子节点层级递增
- **AND** 层级信息必须用于节点样式渲染
- **AND** 层级变更必须触发相关节点更新

#### Scenario: 节点关系验证

- **WHEN** 进行节点操作时
- **THEN** 必须验证父子关系的有效性
- **AND** 不能创建循环引用的父子关系
- **AND** 删除父节点时必须处理子节点关系
- **AND** 关系变更必须保持数据一致性

### Requirement: 侧边栏模式扩展

系统 SHALL 扩展右侧边栏，支持子评论创建模式。

#### Scenario: 子评论创建模式

- **WHEN** 用户点击"+"按钮打开侧边栏时
- **THEN** 侧边栏必须进入"child-comment"模式
- **AND** 标题必须显示"Add Child Comment"
- **AND** 必须显示父节点内容的预览
- **AND** 表单提交按钮必须显示"Add Comment"

#### Scenario: 父节点上下文显示

- **WHEN** 侧边栏处于子评论创建模式时
- **THEN** 必须在侧边栏顶部显示父节点信息
- **AND** 父节点内容预览必须可读但不编辑
- **AND** 必须显示"Replying to: [父节点内容摘要]"
- **AND** 上下文信息必须帮助用户理解回复关系

#### Scenario: 子评论表单验证

- **WHEN** 用户在子评论模式下提交表单时
- **THEN** 必须验证评论内容不能为空
- **AND** 子评论内容长度不能超过500字符
- **AND** 验证失败时必须显示清晰的错误提示
- **AND** 验证通过时才能创建子节点

### Requirement: 基础连接线路径优化

系统 SHALL 提供基本的连接线路径优化功能，避免明显的重叠和交叉。

#### Scenario: 连接线路径规划

- **WHEN** 多个子节点连接到同一父节点时
- **THEN** 连接线路径应进行基本规划以避免重叠
- **AND** 连接线终点必须准确指向目标节点的连接点
- **AND** 路径应保持简洁，不需要复杂的曲线算法

#### Scenario: 连接线交叉避免

- **WHEN** 检测到连接线明显交叉时
- **THEN** 系统应尝试调整连接线路径以减少交叉
- **AND** 调整后的路径应保持连接关系的清晰性
- **AND** 避免算法不应过于复杂，保持实现简洁

### Requirement: 节点拖动位置自动保存

系统 SHALL 在用户拖动节点结束时自动保存新的位置到数据库，确保位置变化的持久化。

#### Scenario: 拖动节点位置保存

- **WHEN** 用户拖动节点并释放鼠标时
- **THEN** 系统必须检测位置变化并调用更新API
- **AND** 必须只在实际位置发生变化时才发送请求
- **AND** API请求必须包含新的x和y坐标值
- **AND** 更新成功时不应干扰用户的其他操作

#### Scenario: 拖动位置变化检测

- **WHEN** 节点拖动结束时
- **THEN** 系统必须比较拖动前后的位置坐标
- **AND** 只有当x或y坐标发生实际变化时才触发保存
- **AND** 微小的位置变化（如小于1像素）可以忽略不计
- **AND** 检测算法应考虑浮点数精度问题

#### Scenario: 拖动保存防抖处理

- **WHEN** 用户快速连续拖动节点时
- **THEN** 系统必须使用防抖机制，延迟300ms后发送API请求
- **AND** 如果在防抖期间再次拖动，必须重置防抖计时器
- **AND** 防抖应确保最后一次位置变化能够正确保存
- **AND** 防抖延迟不应影响用户体验

### Requirement: 拖动保存错误处理

系统 SHALL 提供完善的错误处理机制，确保拖动保存失败时的用户体验。

#### Scenario: 网络错误处理

- **WHEN** 拖动保存API调用失败时
- **THEN** 系统必须显示错误提示信息
- **AND** 错误提示应告知用户保存失败但位置已更新
- **AND** 系统应提供重试机制或建议用户手动刷新
- **AND** 不会回滚节点到拖动前的位置

#### Scenario: API响应处理

- **WHEN** 收到拖动保存API响应时
- **THEN** 成功响应应显示简短的保存成功提示
- **AND** 失败响应应显示详细的错误信息
- **AND** 系统应记录错误信息用于调试
- **AND** 用户应能够继续正常使用其他功能

#### Scenario: 并发冲突处理

- **WHEN** 多个操作同时更新同一节点位置时
- **THEN** 系统应采用后写入者胜出策略
- **AND** 不应显示冲突警告或需要用户确认
- **AND** 最终保存的位置应为最后一次成功的更新
- **AND** 系统应保持数据一致性

### Requirement: 拖动性能优化

系统 SHALL 优化拖动操作的性能，确保流畅的用户体验。

#### Scenario: 拖动性能监控

- **WHEN** 用户进行拖动操作时
- **THEN** 系统必须监控拖动响应性能
- **AND** 拖动过程不应出现明显的延迟或卡顿
- **AND** 节点移动应跟随鼠标位置平滑更新
- **AND** 位置保存操作不应阻塞后续的用户交互

#### Scenario: 大量节点拖动优化

- **WHEN** 画布包含大量节点时
- **THEN** 拖动性能应保持良好，不应明显下降
- **AND** 系统应优化渲染性能，避免不必要的重绘
- **AND** 位置保存API调用不应影响其他节点的显示
- **AND** 内存使用应保持在合理范围内

#### Scenario: 拖动状态管理

- **WHEN** 节点正在被拖动时
- **THEN** 系统可以显示拖动状态指示器
- **AND** 可以临时禁用某些可能冲突的操作
- **AND** 拖动结束后应立即恢复正常状态
- **AND** 状态管理不应影响其他节点的正常操作

